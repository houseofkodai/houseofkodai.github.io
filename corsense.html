<!doctype html><html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
html {overflow-y:scroll;box-sizing:border-box;}
img, object, embed {max-width:100%;height:auto;}
body {margin:0 auto;max-width:50rem;line-height:1.6;background:#FAFAFA;}
@media(max-width:50rem) {body {padding:1rem;}}
</style>
<title>bluetooth rr monitor</title>
</head>
<body>
<button id="btnConnect">Connect</button>
<pre id="log"></pre>
<script>
var _el = {}
var bldev;
var hrmCharacterstic;
var dv;

function log(s,showTime=true) {
  if (!_el.log) {
    _el.log = document.getElementById('log');
  }
  if (showTime) {
    let prefix = function(d) { if (d < 10) { return '0'+d; } else { return ''+d; } }
    let d = new Date();
    _el.log.innerText += '\n' + prefix(d.getHours())+':'+prefix(d.getMinutes())+':'+prefix(d.getSeconds())+': '+s;
  } else {
    _el.log.innerText += '\n' + s;
  }
}

function onDisconnected(evt) {
  console.log('onDisconnected', evt);
  hrmCharacterstic = null;
  _el.btnConnect.textContent = 'Start';
}

function dataView2Hex(value) {
  let a = [];
  for (let i = 0; i < value.byteLength; i++) {
    a.push('0x' + ('00' + value.getUint8(i).toString(16)).slice(-2));
  }
  return a.join(' ')
}

function onHeartRateData(event) {
  dv = event.target.value; //dataview
  var hr = dv.getUint8(1);
  var rr = dv.getUint16(5);
  log(hr + ' ' + rr);
}

function btnClick(evt) {
  if (!bldev) {
    log('Selecting device to pair... ');
    navigator.bluetooth.requestDevice({filters:[{
      optionalService: ['0000180d-0000-1000-8000-00805f9b34fb'],
      namePrefix:'CorSense'}]})
    .then(function(device){
      bldev = device;
      bldev.addEventListener('gattserverdisconnected', onDisconnected);
      btnClick();})
    .catch(function(error) {log(error);});
  } else if (!bldev.gatt.connected) {
    log('Connecting to device '+bldev.name+'...');
    bldev.gatt.connect()
    .then(function(server){
      log('Getting Service...');
      return server.getPrimaryService('heart_rate');})
    .then(function(service) {
      log('Getting Charactistic...')
      return service.getCharacteristic('heart_rate_measurement');})
    .then(function(characterstic){
      hrmCharacterstic = characterstic;
      _el.btnConnect.enabled = false;
      btnClick();})
    .catch(function(error) {log(error);});
  } else if (hrmCharacterstic) {
    _el.btnConnect.enabled = true;
    log(_el.btnConnect.textContent)
    if ('Stop' == _el.btnConnect.textContent) {
      hrmCharacterstic.stopNotifications()
      .then(function(){
        log('> Notifications stopped');
        hrmCharacterstic.removeEventListener('characteristicvaluechanged', onHeartRateData);
        _el.btnConnect.textContent = 'Start';
      })
      .catch(function(error) {log(error);});
    } else {
      hrmCharacterstic.startNotifications()
      .then(function() {
        log('> Notifications started');
        hrmCharacterstic.addEventListener('characteristicvaluechanged', onHeartRateData);
        _el.btnConnect.textContent = 'Stop';
      })
      .catch(function(error) {log(error);});
    }
  };
}

function main() {
  _el.btnConnect = document.getElementById('btnConnect');
  _el.btnConnect.addEventListener('click', btnClick);
}
window.addEventListener('load', function(){setTimeout(main,0)}, false)
</script>
</body>
</html>
